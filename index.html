<!DOCTYPE html>
<html lang="zh" class="h-full">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Towns 空投 批量查询</title>
<link rel="icon" href="deuzo-th0l9-001.ico" />
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-full bg-slate-50 text-slate-800">
  <main class="mx-auto max-w-5xl p-6">
    <h1 class="text-2xl font-semibold text-blue-700 text-center mb-6">
      Towns 空投 批量查询
    </h1>

    <!-- 统计栏 -->
    <div id="stats" class="hidden mb-4 grid grid-cols-1 sm:grid-cols-3 gap-2 text-center text-sm">
      <div class="rounded-md bg-white p-3 border border-slate-200">
        查询地址数<br><span id="totalCnt" class="text-xl font-bold">0</span>
      </div>
      <div class="rounded-md bg-white p-3 border border-slate-200">
        符合资格数<br><span id="okCnt" class="text-xl font-bold text-green-600">0</span>
      </div>
      <div class="rounded-md bg-white p-3 border border-slate-200">
        可领 TOWNS 总量<br><span id="sumAmt" class="text-xl font-bold text-blue-600">0</span>
      </div>
    </div>

    <p class="text-sm text-slate-500 mb-2">
      粘贴钱包地址（一行一个），点击 <b>查询</b>。
    </p>
    <textarea id="addrBox"
      class="w-full h-40 p-3 rounded-md border border-slate-300 bg-white focus:ring-2 focus:ring-blue-500 focus:outline-none"
      placeholder="0xabc...\n0xdef...\n..."
    ></textarea>

    <div class="space-y-3 sm:space-x-3 mt-4 flex flex-col sm:flex-row">
      <button id="queryBtn"
        class="px-4 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-700">
        查询
      </button>
      <button id="copyEligible" class="hidden px-4 py-2 rounded-md bg-slate-600 text-white hover:bg-slate-700">
        复制符合资格结果
      </button>

      <!-- 脱敏开关 -->
      <label class="inline-flex items-center text-sm gap-1.5">
        <input id="maskToggle" type="checkbox" class="h-4 w-4 text-blue-600" checked>
        脱敏显示地址
      </label>
    </div>

    <!-- 额外按钮 -->
    <div class="flex flex-wrap gap-3 mt-6 text-sm">
      <a href="https://eligibility.towns.com/check" target="_blank"
         class="px-3 py-1.5 rounded-md bg-emerald-600 text-white hover:bg-emerald-700">
        官方空投查询传送门
      </a>
      <a href="https://x.com/0xXIAOc" target="_blank"
         class="px-3 py-1.5 rounded-md bg-sky-600 text-white hover:bg-sky-700">
        作者推特 @0xXIAOc
      </a>
    </div>

    <div class="overflow-x-auto mt-6">
      <table id="table" class="hidden min-w-full text-sm text-left">
        <thead class="bg-slate-200">
          <tr>
            <th class="px-3 py-2">#</th>
            <th class="px-3 py-2">地址</th>
            <th class="px-3 py-2">状态</th>
            <th class="px-3 py-2">代币数量 (TOWNS)</th>
            <th class="px-3 py-2">积分</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-200"></tbody>
      </table>
    </div>
  </main>

<script>
const API = '/api/proxy?address=';
const $ = s => document.querySelector(s);
const tbody = $('#table tbody');

// helpers
const fmt = n => (+n / 1e18).toLocaleString('en-US', {maximumFractionDigits:2});
const maskAddr = (a, masked) => masked ? a.slice(0,6)+'…' : a;

let latestRows = [];   // 保存行数据以便切换脱敏

$('#maskToggle').onchange = () => {
  const masked = $('#maskToggle').checked;
  latestRows.forEach(({cell, addr}) => { cell.textContent = maskAddr(addr, masked);});
};

$('#queryBtn').onclick = async () => {
  const raw = $('#addrBox').value.trim();
  const addrs = Array.from(new Set(raw.split(/\s+/).filter(a => /^0x[a-fA-F0-9]{40}$/.test(a))));
  if (!addrs.length) return alert('请输入有效地址!');

  // reset
  tbody.innerHTML = '';
  latestRows = [];
  $('#table').classList.remove('hidden');
  $('#stats').classList.add('hidden');
  $('#copyEligible').classList.add('hidden');

  let okCnt = 0, sumAmt = 0;
  const eligibleLines = [];

  for (let i = 0; i < addrs.length; i++) {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="px-3 py-2">${i + 1}</td>
      <td class="px-3 py-2" id="addr${i}"></td>
      <td class="px-3 py-2" id="s${i}">
        <svg class="animate-spin h-4 w-4 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4l3-3-3-3v4A8 8 0 104 12z"></path></svg>
      </td>
      <td class="px-3 py-2" id="amt${i}">—</td>
      <td class="px-3 py-2" id="pts${i}">—</td>`;
    tbody.appendChild(tr);
    const addrCell = $('#addr'+i);
    addrCell.textContent = maskAddr(addrs[i], $('#maskToggle').checked);
    latestRows.push({cell: addrCell, addr: addrs[i]});

    try {
      const res = await fetch(API + addrs[i]).then(r => r.json());
      if (res.isEligible) {
        okCnt++;
        const amtToken = +res.amount / 1e18;
        sumAmt += amtToken;

        $('#s'+i).innerHTML = '<span class="text-green-600 font-semibold">✅ Eligible</span>';
        $('#amt'+i).textContent = fmt(res.amount);
        $('#pts'+i).textContent = fmt(res.points);

        eligibleLines.push(`${addrs[i]},${amtToken}`);
      } else {
        $('#s'+i).innerHTML = '<span class="text-red-600 font-semibold">❌ Not</span>';
      }
    } catch {
      $('#s'+i).innerHTML = '<span class="text-red-600">错误</span>';
    }
  }

  // 更新统计栏
  $('#totalCnt').textContent = addrs.length;
  $('#okCnt').textContent = okCnt;
  $('#sumAmt').textContent = sumAmt.toLocaleString('en-US', {maximumFractionDigits:2});
  $('#stats').classList.remove('hidden');

  // 复制按钮
  if (eligibleLines.length) {
    $('#copyEligible').classList.remove('hidden');
    $('#copyEligible').onclick = () => navigator.clipboard.writeText(eligibleLines.join('\n'));
  }
};
</script>
</body>
</html>
